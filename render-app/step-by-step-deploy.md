# Пошаговая инструкция по деплою на Render.com

Эта инструкция содержит подробные шаги по развертыванию приложения BNAL Bank на платформе Render.com, включая скриншоты и детальные объяснения каждого этапа.

## Содержание
- [Подготовка репозитория](#подготовка-репозитория)
- [Настройка сервиса на Render.com](#настройка-сервиса-на-rendercom)
- [Настройка переменных окружения](#настройка-переменных-окружения)
- [Настройка постоянного хранилища](#настройка-постоянного-хранилища)
- [Мониторинг деплоя](#мониторинг-деплоя)
- [Устранение типичных проблем](#устранение-типичных-проблем)

## Подготовка репозитория

### Вариант 1: Загрузка всего проекта на GitHub

1. Создайте новый репозиторий на GitHub
2. Загрузите содержимое директории `render-app` в корень репозитория

Структура репозитория должна выглядеть так:
```
/
├── build.sh
├── start.sh
├── setup-telegram.js
├── package.json
├── render.yaml
├── client/
├── server/
├── shared/
└── другие файлы...
```

### Вариант 2: Загрузка только директории render-app

1. Создайте новый репозиторий на GitHub
2. Загрузите директорию `render-app` со всем содержимым

Структура репозитория будет:
```
/
└── render-app/
    ├── build.sh
    ├── start.sh
    ├── setup-telegram.js
    ├── package.json
    ├── render.yaml
    ├── client/
    ├── server/
    ├── shared/
    └── другие файлы...
```

## Настройка сервиса на Render.com

1. Зайдите в [Dashboard Render.com](https://dashboard.render.com/)
2. Нажмите на кнопку **New +** в верхней части экрана
3. Выберите **Web Service**
4. Подключите ваш GitHub репозиторий 
5. На экране настройки:

   ![Настройка сервиса](https://docs.render.com/static/97efd5c24c1f78d799ad094c30ec3f82/a7715/01-configure-a-web-service.png)

   - **Name**: `bnal-bank` (или другое имя)
   - **Environment**: `Node`
   - **Region**: Выберите ближайший регион
   - **Branch**: `main` (или ваша основная ветка)
   
6. Для **Root Directory**:
   - Если вы загрузили весь проект в корень репозитория: оставьте пустым или укажите `.` (точку)
   - Если вы загрузили директорию `render-app`: укажите `render-app`

7. Для команд сборки и запуска:
   - **Build Command**: `chmod +x build.sh && ./build.sh`
   - **Start Command**: `chmod +x start.sh && ./start.sh`

8. Выберите план:
   - Для тестирования: Free ($0/month)
   - Для производственного использования: Starter ($7/month)

## Настройка переменных окружения

1. Прокрутите страницу вниз до раздела **Environment Variables**
2. Добавьте следующие переменные:

   ![Переменные окружения](https://docs.render.com/static/1bb09d6e86c1bc1cc0e9e8d26dc6fb09/a7715/07-environment-variables.png)

   - `NODE_ENV` = `production`
   - `RENDER` = `true`
   - `TELEGRAM_BOT_TOKEN` = ваш токен бота
   - `COINGECKO_API_KEY` = ваш API ключ (опционально)
   - `SESSION_SECRET` = оставьте пустым, Render сгенерирует автоматически

3. Для получения токена Telegram бота:
   - Откройте Telegram, найдите [@BotFather](https://t.me/BotFather)
   - Отправьте `/newbot` и следуйте инструкциям
   - Скопируйте полученный токен

## Настройка постоянного хранилища

1. В той же форме настройки прокрутите до раздела **Disks**
2. Нажмите на **Add Disk**

   ![Добавление диска](https://docs.render.com/static/8ee8deeb6d6e1e3ea6af6bd7aaf9c5f3/a7715/14-disk-default-values.png)

3. Настройте диск:
   - **Name**: `data`
   - **Mount Path**: `/data`
   - **Size**: `1 GB`

## Мониторинг деплоя

1. Нажмите **Create Web Service** внизу страницы
2. Render начнет процесс деплоя, который можно отслеживать в разделе **Logs**
3. Успешный деплой займет 5-10 минут
4. После завершения вы увидите URL вашего приложения и статус **Live**

   ![Успешный деплой](https://docs.render.com/static/bc5e59bc3668fe26f92d4c183ddc7e99/a7715/21-streaming-logs-2.png)

5. Откройте URL приложения в браузере
6. Войдите с учетными данными:
   - Логин: `admin`
   - Пароль: `admin123`

## Устранение типичных проблем

### Ошибка: "Корневой каталог службы отсутствует"

**Причина**: Неверно указан Root Directory или структура репозитория не соответствует ожидаемой.

**Решение**:
1. В настройках сервиса на Render.com выберите **Settings**
2. В разделе **Build & Deploy** найдите **Root Directory**
3. Укажите корректное значение:
   - Если файлы в корне репозитория: оставьте пустым или укажите `.`
   - Если файлы в директории: укажите правильный путь к директории
4. Нажмите **Save Changes** и **Manual Deploy** > **Clear build cache & deploy**

### Ошибка: "Build failed"

**Причина**: Проблемы при установке зависимостей или компиляции.

**Решение**:
1. Проверьте логи сборки в разделе **Logs**
2. Обычно ошибки связаны с несовместимостью версий пакетов
3. В нашем build.sh уже добавлены флаги `--force`, `--no-optional` и обработка ошибок
4. Если проблема сохраняется, можно временно изменить флаги в build.sh и более подробные логи

### Ошибка API CoinGecko: 403

**Причина**: Ограничения бесплатного API CoinGecko.

**Решение**:
1. Зарегистрируйтесь на [CoinGecko Pro](https://www.coingecko.com/en/api/pricing)
2. Получите API ключ
3. Добавьте его в переменные окружения как `COINGECKO_API_KEY`
4. Выполните повторный деплой

### Проблемы с Telegram ботом

**Причина**: Неверный токен или проблемы настройки webhook.

**Решение**:
1. Убедитесь, что токен бота верный
2. Проверьте логи приложения на наличие ошибок настройки webhook
3. В нашем случае для production среды автоматически настраивается webhook
4. Для отладки добавьте временную печать логов в setup-telegram.js